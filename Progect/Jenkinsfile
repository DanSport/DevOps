pipeline {
  agent {
    kubernetes {
      // якщо у тебе вже є podTemplate "kaniko" у Jenkins — можна залишити цю стрічку;
      // якщо ні — все одно спрацює, бо нижче ми явно додаємо containerTemplate.
      inheritFrom 'kaniko'

      // явне визначення контейнера Kaniko (без YAML)
      containerTemplate {
        name 'kaniko'
        image 'gcr.io/kaniko-project/executor:latest'
        command 'cat'
        ttyEnabled true
        // кеш каніко
        volumeMounts([volumeMount(name: 'kaniko-cache', mountPath: '/kaniko/.cache')])
      }
      volumes {
        emptyDirVolume(mountPath: '/kaniko/.cache', memory: false, name: 'kaniko-cache')
      }
      // за замовчуванням jnlp як робочий контейнер
      defaultContainer 'jnlp'
      serviceAccount 'jenkins'
    }
  }

  environment {
    AWS_REGION    = 'us-east-1'
    ECR_URI       = '785434010839.dkr.ecr.us-east-1.amazonaws.com/lesson-7-ecr'
    APP_NAME      = 'django-app'
    GITOPS_BRANCH = 'lesson-8-9'
    VALUES_FILE   = 'Progect/charts/django-app/values.yaml'
    GIT_SSH_URL   = 'git@github.com:DanSport/DevOps.git'
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
        sh 'git rev-parse --short HEAD && git status'
      }
    }

    stage('Build & Push (Kaniko)') {
      steps {
        container('kaniko') {
          sh '''
            set -euxo pipefail
            TAG="build-${BUILD_NUMBER}"
            /kaniko/executor \
              --context="$WORKSPACE" \
              --dockerfile=Dockerfile \
              --destination="${ECR_URI}:${TAG}" \
              --destination="${ECR_URI}:latest" \
              --cache=true --snapshotMode=redo
            echo "${TAG}" > .image_tag
          '''
        }
      }
    }

    stage('Bump Helm values & Push') {
      steps {
        sshagent (credentials: ['gitops-ssh']) {
          sh '''
            set -euxo pipefail
            TAG="$(cat .image_tag)"

            # на пуш міняємо URL на SSH
            git remote set-url origin "${GIT_SSH_URL}"

            git fetch origin "${GITOPS_BRANCH}"
            git checkout "${GITOPS_BRANCH}"

            if command -v yq >/dev/null 2>&1; then
              yq -i '.image.tag = env(TAG)' "${VALUES_FILE}"
            else
              sed -i.bak -E "s#^(\\s*tag:\\s*).*#\\1${TAG}#g" "${VALUES_FILE}"
              rm -f "${VALUES_FILE}.bak"
            fi

            git config user.email "ci@local"
            git config user.name  "jenkins-ci"
            git add "${VALUES_FILE}" || true
            git commit -m "ci: bump ${APP_NAME} image tag to ${TAG} [skip ci]" || echo "No changes to commit"
            git push origin "${GITOPS_BRANCH}"
          '''
        }
      }
    }
  }

  post {
    success { echo '✅ Образ у ECR, values.yaml оновлено — Argo CD підхопить зміни.' }
    failure { echo '❌ Пайплайн впав — глянь лог стадії вище.' }
  }
}
