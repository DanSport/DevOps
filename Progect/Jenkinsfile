pipeline {
  agent {
    kubernetes {
      yaml """
apiVersion: v1
kind: Pod
metadata:
  labels:
    jenkins: agent
spec:
  serviceAccountName: jenkins-sa
  volumes:
    - name: workspace-volume
      emptyDir: {}
  containers:
    - name: git-tools
      image: public.ecr.aws/bitnami/git:2.45.2
      command: ["cat"]
      tty: true
      volumeMounts:
        - name: workspace-volume
          mountPath: /home/jenkins/agent
      resources:
        requests: { cpu: "50m",  memory: "64Mi" }
        limits:   { cpu: "500m", memory: "256Mi" }

    - name: kaniko
      image: gcr.io/kaniko-project/executor:debug
      command: ["cat"]
      tty: true
      volumeMounts:
        - name: workspace-volume
          mountPath: /home/jenkins/agent
      resources:
        requests: { cpu: "100m", memory: "128Mi" }
        limits:   { cpu: "1",    memory: "1Gi" }

    - name: jnlp
      image: jenkins/inbound-agent:3327.v868139a_d00e0-6
      args: ['\$(JENKINS_SECRET)', '\$(JENKINS_NAME)']
      env:
        - name: JENKINS_URL
          value: "http://jenkins.jenkins.svc.cluster.local:80/"
        - name: JENKINS_TUNNEL
          value: "jenkins-agent.jenkins.svc.cluster.local:50000"
      resources:
        requests: { cpu: "100m", memory: "256Mi" }
      volumeMounts:
        - name: workspace-volume
          mountPath: /home/jenkins/agent
"""
      defaultContainer 'git-tools'
    }
  }

  environment {
    AWS_REGION    = 'us-east-1'
    ECR_URI       = '785434010839.dkr.ecr.us-east-1.amazonaws.com/lesson-7-ecr'
    APP_NAME      = 'django-app'
    GITOPS_BRANCH = 'main'   // пушимо в main
    VALUES_FILE   = 'Progect/charts/django-app/values.yaml'
    GIT_SSH_URL   = 'git@github.com:DanSport/DevOps.git'
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
        sh '''#!/usr/bin/env bash
set -euo pipefail
git --version
git config --global --add safe.directory "$WORKSPACE" || true
git rev-parse --short HEAD || true
'''
      }
    }

    stage('Build & Push (Kaniko)') {
      steps {
        container('kaniko') {
          sh '''#!/bin/sh -eux
TAG="build-${BUILD_NUMBER}"
/kaniko/executor \
  --context="$WORKSPACE" \
  --dockerfile=Dockerfile \
  --destination="${ECR_URI}:${TAG}" \
  --cache=false
echo "${TAG}" > .image_tag
'''
        }
      }
    }

    stage('Bump Helm values & Push') {
  when { expression { return env.TAG?.trim() } } // щоб мати TAG з попередньої стадії
  steps {
    container('git-tools') {
      sshagent(credentials: ['gitops-ssh']) {
        sh '''
          set -euo pipefail
          export HELM_VALUES="chart/values.yaml"   # <=== ПОМІНЯЙ на свій шлях

          # known_hosts для GitHub
          mkdir -p ~/.ssh
          ssh-keyscan -t ed25519 github.com >> ~/.ssh/known_hosts
          chmod 700 ~/.ssh
          chmod 600 ~/.ssh/known_hosts

          # налаштування git та гарантовано SSH remote
          git config user.name "Jenkins CI"
          git config user.email "ci@local"
          git remote set-url origin git@github.com:DanSport/DevOps.git

          # bump образу у values
          sed -i "s|^\\s*tag:\\s*.*$|  tag: ${TAG}|g" "$HELM_VALUES"

          git add "$HELM_VALUES" || true
          git commit -m "ci: bump image tag to ${TAG} [skip ci]" || true

          # пуш у потрібну гілку (за потреби поміняй на main)
          git push origin HEAD:lesson-8-9
        '''
      }
    }
  }
}
  }

  post {
    success { echo '✅ Образ у ECR запушено і values.yaml оновлено. Зроби merge main → lesson-8-9, щоб Argo CD підхопив.' }
    failure { echo '❌ Дивись логи конкретної стадії (Kaniko / Push у Git).' }
  }
}
